name: build-web-artifact
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    # PUBLIC build-time envs only; secrets stay on VPS
    env:
      NEXT_PUBLIC_WEBAPP_URL: https://cal.geekist.co
      NEXT_PUBLIC_WEBSITE_URL: https://cal.geekist.co
      NEXT_PUBLIC_CONSOLE_URL: https://cal.geekist.co
      NEXT_PUBLIC_EMBED_LIB_URL: https://cal.geekist.co/embed/embed.js
      # IMPORTANT: full auth base, not just the domain
      NEXTAUTH_URL: https://cal.geekist.co/api/auth
      NEXTAUTH_SECRET: ${{ secrets.CI_NEXTAUTH_SECRET }}
      CALENDSO_ENCRYPTION_KEY: ${{ secrets.CI_CALENDSO_ENCRYPTION_KEY }}
      PRISMA_SKIP_GENERATE: true
      # Turn on Next.js standalone output per your next.config.js
      BUILD_STANDALONE: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 18 + Corepack
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: corepack enable

      # IMPORTANT: do a normal install to avoid YN0028 (lockfile edits forbidden)
      # We are *not* using --immutable here on purpose.
      - name: Yarn install
        run: yarn install

      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            **/.turbo/**
          key: yarn-${{ hashFiles('yarn.lock') }}
      # 1) Build atoms (sequential)
      - name: Build atoms first
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn turbo run build --filter=@calcom/atoms
      # 2) Build emails (sequential)
      - name: Build atoms first
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn turbo run build --filter=@calcom/emails...        
      # 3) Build web + its deps
      - name: Build web (+deps)
        env:
          NODE_OPTIONS: --max_old_space_size=8192   # 8 GB heap for node builders
          TURBO_CONCURRENCY: 2                      # fewer parallel builds = lower peak RAM
        run: yarn turbo run build --filter=@calcom/web...

      # Package Next.js standalone output
      - name: Pack artefact (standalone)
        working-directory: apps/web
        run: |
          tar czf /tmp/cal-web.tgz \
            .next/standalone \
            .next/static \
            public \
            next.config.js \
            package.json

      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: cal-web
          path: /tmp/cal-web.tgz
          retention-days: 7
