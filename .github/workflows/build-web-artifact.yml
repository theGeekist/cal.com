name: build-web-artifact
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_WEBAPP_URL: https://cal.geekist.co
      NEXT_PUBLIC_WEBSITE_URL: https://cal.geekist.co
      NEXT_PUBLIC_CONSOLE_URL: https://cal.geekist.co
      NEXT_PUBLIC_EMBED_LIB_URL: https://cal.geekist.co/embed/embed.js
      NEXTAUTH_URL: https://cal.geekist.co/api/auth
      NEXTAUTH_SECRET: ${{ secrets.CI_NEXTAUTH_SECRET }}
      CALENDSO_ENCRYPTION_KEY: ${{ secrets.CI_CALENDSO_ENCRYPTION_KEY }}
      PRISMA_SKIP_GENERATE: true
      BUILD_STANDALONE: "true"
      # Optional: speeds Yarn in CI
      YARN_ENABLE_INLINE_BUILDS: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 18 + Corepack
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: corepack enable

      # ---------- CACHES (restore before install; same key used to save) ----------
      - name: Yarn cache (Berry tarballs)
        uses: actions/cache@v4
        with:
          path: .yarn/cache
          key: yarn-${{ runner.os }}-node18-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-node18-
            yarn-                        # adopt previously-saved caches like "yarn-<lockhash>"

      - name: Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-node18-${{ github.ref_name }}-${{ hashFiles('**/*.ts','**/*.tsx','**/package.json','yarn.lock') }}
          restore-keys: |
            turbo-${{ runner.os }}-node18-${{ github.ref_name }}-
            turbo-${{ runner.os }}-node18-

      # ---------- INSTALL ----------
      # If your lockfile is now stable, switch to: yarn install --immutable
      - name: Yarn install
        run: yarn install

      # ---------- BUILD ----------
      - name: Build atoms first
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn turbo run build --filter=@calcom/atoms

      - name: Generate Prisma client (dual engines)
        run: yarn --cwd packages/prisma prisma generate --schema packages/prisma/schema.prisma

      - name: Build web (+deps)
        env:
          NODE_OPTIONS: --max_old_space_size=8192
          TURBO_CONCURRENCY: 2
        run: yarn turbo run build --filter=@calcom/web...

      # ---------- PACKAGE ----------
      - name: Pack artefact (standalone)
        working-directory: apps/web
        run: |
          tar czf /tmp/cal-web.tgz \
            .next/standalone \
            .next/static \
            public \
            next.config.js \
            package.json

      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: cal-web
          path: /tmp/cal-web.tgz
          retention-days: 7
