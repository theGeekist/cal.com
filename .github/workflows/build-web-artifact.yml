name: build-web-artifact
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_WEBAPP_URL: https://cal.geekist.co
      NEXT_PUBLIC_WEBSITE_URL: https://cal.geekist.co
      NEXT_PUBLIC_CONSOLE_URL: https://cal.geekist.co
      NEXT_PUBLIC_EMBED_LIB_URL: https://cal.geekist.co/embed/embed.js
      NEXTAUTH_URL: https://cal.geekist.co/api/auth
      NEXTAUTH_SECRET: ${{ secrets.CI_NEXTAUTH_SECRET }}
      CALENDSO_ENCRYPTION_KEY: ${{ secrets.CI_CALENDSO_ENCRYPTION_KEY }}
      BUILD_STANDALONE: "true"
      PRISMA_SKIP_POSTINSTALL_GENERATE: "true"   # <-- stop noisy postinstalls
      YARN_ENABLE_INLINE_BUILDS: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 18 + Corepack
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: corepack enable

      - name: Yarn cache (Berry tarballs)
        uses: actions/cache@v4
        with:
          path: .yarn/cache
          key: yarn-${{ runner.os }}-node18-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-node18-
            yarn-

      - name: Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-node18-${{ github.ref_name }}-${{ hashFiles('**/*.ts','**/*.tsx','**/package.json','yarn.lock') }}
          restore-keys: |
            turbo-${{ runner.os }}-node18-${{ github.ref_name }}-
            turbo-${{ runner.os }}-node18-

      - name: Yarn install
        run: yarn install
        # once stable, switch to: yarn install --immutable

      - name: Build atoms first
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn turbo run build --filter=@calcom/atoms

      - name: Generate Prisma client
        run: |
          set -e
          echo "Attempt 1: run from packages/prisma with short schema path"
          if [ -f packages/prisma/schema.prisma ]; then
            (cd packages/prisma && yarn prisma generate --schema schema.prisma) && exit 0
          fi  
          echo "❌ Could not find schema.prisma in either location"
          ls -la
          exit 1

      - name: Build web (+deps)
        env:
          NODE_OPTIONS: --max_old_space_size=8192
          TURBO_CONCURRENCY: 2
        run: yarn turbo run build --filter=@calcom/web...

      - name: Pack artefact (standalone)
        working-directory: apps/web
        run: |
          tar czf /tmp/cal-web.tgz \
            .next/standalone \
            .next/static \
            public \
            next.config.js \
            package.json

      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: cal-web
          path: /tmp/cal-web.tgz
          retention-days: 7
